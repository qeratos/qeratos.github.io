---
title: "JLAIVE"
author: Qeratos
date: 2025-04-21 10:00:00 +0300
categories: [Reverse, russian]
tags: [Reverse, Malware, PS1, BAT, .NET]
---


Энтропия: 6
Размер: 81.78 KiB
MD5: eb1b1b1fc219887139f391cae06fe2ae
SHA1: 50fba629bcbfa81994cd30e0fc4dbad2ea87d569
SHA256: 6db727f75d26827c936e8380141708c25b9df8c3869fb6bdfe1899bff95781ff

Исходный файл представляет из себя BATС-файл для CMD windows.

![Внешний вид обфусцированного образца](assets/img/jlaive1/img1.png)

Применяет FUD-batch методику для обфускации, с применением манипуляций командой set и MS-DOS строками и переменными. Кратко функционал сводится к заполнению перменных формата `%generated_name%` при помощи команды `set` и конкатенации  переменных в итоговую строку.

Код вредоноса также содержит в себе большую строку, начинающуюся с `::` и имеющую ближе к концу символ `\`.

Вредонос отключает вывод в консоль при помощи `@echo off`.
Первая деобфусцированная строка отвечает за копирование исполняемого файла powershell в директорию, в которой расположен образец:
```bat
copy C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe /y "script.bat.exe"
```


После чего декодируется вторая строка, которая содержит в себе строку для запуска скопированной копии powershell с аргуметами скрывающими выполнение и устанавливающими политику выполнения `bypass`:
```
script.bat.exe -noprofile -w hidden -ep bypass -c "code"
```

В аргументе -c передается следующий код в обфусцированном виде (Изменены имена переменных и функций), после деобфускации код на powershell выглядит следующим образом: 
![[assets/img/jlaive1/img2.png]]

Основной его задачей является распаковка и расшифровка доп нагрузки, по алгоритму:
1) Чтение своего же кода при помощи ReadAllText
2) Поиск строки начинающейся с символов `::`
3) Разделение найденной строки по символу `\`
4) Декодирование из base64 полученных строк
5) Расшифровка при помощи AES с ключом и вектором инициализации, жестко закодированными в теле экземпляра
6) После чего распаковка полученной нагрузки при помощи Gzip, т.к. расшированные данные имеют заголовок с сигнатурой `0x1F, 0x8B` что характерно для GZIP согласно  rfc:1952: ![[Снимок экрана 2025-04-15 в 09.51.33.png]]

Согласно DIE распакованные файлы представляют собой .NET приложения ![[assets/img/jlaive1/img10.png]]


Распакованный исполняемый файл, под номером 1:
```
Имя: 1 (mfNrAR)
Размер: 49.00 KiB 
Энтропия: 7.8
MD5: 93da91b20416c2f1a5026fdd3bf5e49e 
SHA1: b2c0634988717957ed6fc933575c5684a1b6e7a1 
SHA256: afdc48c265cde9b25a60cc6242efe65322ffecf36330284405fc9976118bc560
```

Отвечает за:
распаковку дополнительной нагрузки, которая располагается в ресурсах, с именем `JLAIVE_P`, в основном коде выставляются атрибуты hidden и тип system. Проводится поиск ресурсов с именами отличными от:
1) JLAIVE_P
2) JLAIVE_RP
3) JLAIVE_AU
Если ресурс с отличным именем - ресурс записывается в файл с именем, согласно, имени ресурса. Следом запускается файл, у которого устанавливаются также аттрибуты hidden, system и запускается при помощи Process.Start().

![[assets/img/jlaive1/img3.png]]

Иначе, распаковывается ресурс с именем `JLAIVE_P`, загружается с применением Assembly.Load() и запускается на выполнение при помощи метода Invoke().

![[assets/img/jlaive1/img4.png]]




Распакованный исполняемый файл, под номером 2:
```
Имя: 2 (ZCtDEI)
Энтропия: 4.2
Размер: 6.00 KiB
MD5: 85ed2f7d26b4fc1d80a8185af7b45043 
SHA1: 3976b86d6acb8a502cf539b65bf5d9b9de1cf7a2 
SHA256: e90124fe4902572702d9ecd402f223371bbf1208199b6b20033f976a63a5edb7
```

Отвечает за:
Обход методов обнаружения ВПО на итоговом устройстве путем патчинга системных библиотек [amsi.dll, ntdll.dll].
Строки с шеллкодами зашифрованы, так же как и имена методов, подвергаемых патчингу, при помощи AES шифрования, с указанием вектора инициализации и ключа в формате base64.

При помощи LoadLibrary загружает в свое адресное пространство системную библиотеку kernel32.dll и получает адрес функции VirtualProtect.

Следом загружает библиотеку amsi.dll, ответственную за <>, и проводит поиск метода AmsiScanBuffer:
![[assets/img/jlaive1/img5.png]]

Таблица экспорта Amsi.dll:
![[assets/img/jlaive1/img6.png]]

Далее проводит проверку размера указателя, если он равен  8-ми записывается пэйлоад для 32-битных систем, иначе для 64-битных, при помощи метода Marshal.Copy(). Предварительно пэйлоад расшифровывается при помощи AES.

Результат патчинга - слева.
![[assets/img/jlaive1/img7.png]]

Аналогичные действия проводит для метода EtwEventWrite, библиотеки ntdll.dll. 

Таблица экспорта EtwEventWrite:
![[assets/img/jlaive1/img8.png]]

Также проводится проверка разрядности и запись нагрузки по смещению, изменяемого метода.

Пэйлоады:
```
Function: AmsiScanBuffer
32-bit:   b857000780c30a0a0a0a0a0a0a0a0a0a
64-bit:   b857000780c218000808080808080808

Function: EtwEventWrite
32-bit:   c30f0f0f0f0f0f0f0f0f0f0f0f0f0f0f
64-bit:   c214000d0d0d0d0d0d0d0d0d0d0d0d0d
```

После патчинга функция AmsiScanBuffer обновляет регистр eax значением равным 0х8000 или же 32768, что согласно MSDN является событием с максимальным уровнем опасности проверяемого файла или данных. И возвращает выполнение, не запуская основной код проверки.
``` C++
enum AMSI_RESULT
{
	AMSI_RESULT_CLEAN = 0,
	AMSI_RESULT_NOT_DETECTED = 1,
	AMSI_RESULT_BLOCKED_BY_ADMIN_START = 0x4000,
	AMSI_RESULT_BLOCKED_BY_ADMIN_END = 0x4fff,
	AMSI_RESULT_DETECTED = 32768
} AMSI_RESULT;
```


После патчинга функция EtwEventWrite возвращает 0x14 что согласно описанию GetLastError является событием:
`20: Системе не удается найти указанное устройство.`
Благодаря чему исправляется возможность записи событий в журналы ОС.
![[assets/img/jlaive1/img9.png]]

### Функционал и методики направлены на обход детектирования продуктами класса EDR.


Последний файл, который был распакован и выгружен из экземпляра `mfNrAR`:
```
Имя: JLAIVE_P
Энтропия: 5.8
Размер: 98.50 KiB
MD5: 2c530deb5d4cd0f5a24739f9a422d952 
SHA1: d4ad636c5896795fec5d26a64597b3a489d84626 
SHA256: 69b3211f85045038697487812406d2fcdb74ebe68df661f60796b4a61dc0c276
```
 Является, согласно DIE, .NET исполняемым файлом.
 